# Retarglow Cloudflare Worker

This repository contains the Cloudflare Worker that powers the Retarglow bootstrap endpoint (`/b`) and the embeddable frame endpoint (`/frame`). The worker signs short-lived campaign plans in the bootstrap handler and later verifies them in the frame handler before rendering a sandboxed `<iframe>` pointing at the campaign creative.

## Endpoints

### `/b`
- Accepts POST requests from the publisher bootstrap script.
- Infers visitor context (retarget ID, visit count, screen resolution, etc.) and looks up an active campaign plan in Supabase.
- Signs the plan into a token using the shared HMAC helpers in [`functions/lib/token.js`](functions/lib/token.js) and returns the token together with the frame URL so the publisher can safely embed the creative.

### `/frame`
- Expects a `token` query parameter produced by `/b`.
- Verifies the token signature and expiry and extracts the embedded campaign plan.
- Renders a minimal HTML document that hosts the campaign in an `<iframe>` whose attributes are derived from the plan.

## Multi-publisher compatibility

The worker does not hard-code any publisher specific values. As long as each publisher integrates the bootstrap script and forwards the `token` it receives to `/frame`, the same infrastructure can serve many different publishers:

- Campaign selection in [`functions/b.js`](functions/b.js) is based on the incoming page URL and campaign rules, so different publishers can be mapped to different campaigns without code changes.
- The signed plan only carries the values required to render the frame (`src`, `width`, `height`, `style`, `attributes`), letting each campaign point at any creative URL appropriate for its publisher while maintaining integrity through the HMAC signature handled by [`functions/lib/token.js`](functions/lib/token.js).
- The frame handler in [`functions/frame.js`](functions/frame.js) simply validates the token and mirrors the plan into the response, so any valid plan generated by `/b`—regardless of which publisher triggered it—will render correctly.

If you need to differentiate behaviour for a specific publisher you can extend the plan payload or the Supabase campaign rules without changing the worker logic. The shared signing secret ensures that only tokens created by `/b` are accepted by `/frame`, keeping the integration safe even when multiple publishers are involved.

## Development

- Install dependencies with `npm install`.
- Run syntax checks with `npm run lint`.
- Deploy the worker with `wrangler deploy` once the required environment variables (Supabase credentials and one of the recognised signing secret keys) are configured.
